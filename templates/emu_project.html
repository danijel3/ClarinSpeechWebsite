{% extends "layout.html" %}
{% block body %}
    <h1>{% trans %}emu_projekt_tytuł{% endtrans %}</h1>

    <div class="card form-control card-block">
        <div class="form-group row">
            <p class="col-2">{% trans %}stworzony_przez{% endtrans %}</p>
            <p class="col-6"><b>{{ proj.owner }}</b></p>
            <p class="col-4">{{ create_date }}</p>
        </div>
        <div class="form-group row">
            <p class="col-2">{% trans %}widoczność{% endtrans %}</p>
            <p class="col-10">
                {% if proj.visibility == 'public' %}
                    <i class="fa fa-globe"></i>&nbsp;
                    {% trans %}publiczny{% endtrans %}
                {% elif proj.visibility == 'viewonly' %}
                    <i class="fa fa-eye"></i>&nbsp;
                    {% trans %}tylko_do_odczytu{% endtrans %}
                {% else %}
                    <i class="fa fa-lock"></i>&nbsp;
                    {% trans %}prywatny{% endtrans %}
                {% endif %}
                {% if logged_in %}
                    <span class="text-muted small">
                    <a href="logout/{{ proj._id }}" class="btn btn-warning btn-sm">
                        {% trans %}wyloguj_się{% endtrans %}
                    </a>                    </span>
                {% else %}
                    <a href="password/{{ proj._id }}" class="btn btn-success btn-sm">
                        <i class="fa fa-key"></i>
                        {% trans %}zaloguj_się{% endtrans %}
                    </a>
                {% endif %}
            </p>
        </div>
        <div class="form-group row">
            <p class="col-2">{% trans %}opis{% endtrans %}</p>
            <p class="col-10"><b>{{ proj.description }}</b></p>
        </div>
        {% if can_admin %}
            <div class="form-group row">
                <div class="col-2">
                    <button id="btn_modify" type="button" class="btn btn-info" data-toggle="collapse" href="#project"
                            aria-expanded="false" aria-controls="project" style="width: 100%">
                        {% trans %}modyfikuj{% endtrans %}
                    </button>
                </div>
            </div>
        {% endif %}

        {% if can_admin %}
            <div class="collapse" id="project">
                <div class="card form-control card-block">
                    <form action="modify/{{ proj._id }}" method="POST" onsubmit="return verify_submit()">

                        <div class="form-group row">
                            <label for="owner" class="col-2 col-form-label">{% trans %}właściciel{% endtrans %}</label>
                            <div class="col-10">
                                <input id="owner" name="owner" value="{{ proj.owner }}" class="form-control">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="desc" class="col-2 col-form-label">{% trans %}opis{% endtrans %}</label>
                            <div class="col-10">
                            <textarea id="desc" name="desc" class="form-control"
                                      rows="3">{{ proj.description }}</textarea>
                            </div>
                        </div>

                        <div id="pass_row" class="form-group">
                            <div class="row">
                                <label for="pass" class="col-2 col-form-label ">{% trans %}hasło{% endtrans %}</label>
                                <div class="col-5">
                                    <input type="password" id="pass" name="pass" value="{{ pass_check }}"
                                           class="form-control form-control-danger"
                                           placeholder="{% trans %}hasło{% endtrans %}">
                                    <input type="hidden" id="pass_check" name="pass_check" value="{{ pass_check }}">
                                </div>
                                <div class="col-5">
                                    <input type="password" id="pass_rep" class="form-control form-control-danger"
                                           placeholder="{% trans %}powtórz_hasło{% endtrans %}">
                                </div>
                            </div>
                            <div class="row">
                                <div id="pass_fb" class="col-sm-3 offset-sm-2 form-control-feedback invisible">
                                    {% trans %}hasła_się_różnią{% endtrans %}
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-7">&nbsp;</div>
                            <div class="col-2">
                                <a class="btn btn-danger ask-delete" style="width:100%" href="remove/{{ proj._id }}">
                                    <i class="fa fa-trash" aria-hidden="true"></i>
                                    {% trans %}usuń{% endtrans %}
                                </a>
                            </div>
                            <div class="col-3">
                                <button id="btn_save" type="submit" class="btn btn-primary" style="width:100%">
                                    <i class="fa fa-floppy-o" aria-hidden="true"></i>
                                    {% trans %}zapisz{% endtrans %}
                                </button>
                            </div>
                        </div>
                    </form>
                    <script type="text/javascript">
                        $('#pass').change(verify_password);
                        $('#pass_rep').change(verify_password);

                        function verify_submit() {
                            if (!confirm('{% trans %}czy_zapisać_zmiany{% endtrans %}')) {
                                $('#pass').val($('#pass_check').val());
                                $('#pass-rep').val($('#pass_check').val());
                                return false;
                            }
                            if ($('#pass').val() != $('#pass_check').val()) {
                                if (!verify_password()) {
                                    alert('{% trans %}hasła_się_różnią{% endtrans %}');
                                    return false;
                                }
                            }
                            return true;
                        }

                        function verify_password() {
                            if ($('#pass').val() != $('#pass_rep').val()) {
                                $('#pass_row').addClass('has-danger');
                                $('#pass_fb').removeClass('invisible');
                                return false;
                            } else {
                                $('#pass_row').removeClass('has-danger');
                                $('#pass_fb').addClass('invisible');
                                return true;
                            }
                        }
                    </script>
                </div>
            </div>
            </div>
        {% endif %}

    <!-- END top page info and form -->

    <div class="card form-control card-block">

        {% if can_modify %}
            <form action="add_audio/{{ proj._id }}" class="dropzone form-group" id="addAudio">
                <div class="dz-message needsclick">
                    {% trans %}pliki_click_drag_opis{% endtrans %}
                </div>
            </form>
            <div class="progress form-group">
                <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar"
                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
            </div>
        {% endif %}

        {% if refresh_req %}
            <div class="alert alert-info fade show" role="alert">
                <span class="fa fa-refresh fa-spin"></span>
                {% trans %}w trakcie przetwarzania, odświeżam za {% endtrans %}
                <span id="refresh-sec">5</span> s...
                {% trans %}kliknij <a id="refresh-link" href="#">tutaj</a> żeby odświeżyć natychmiast{% endtrans %}
                <button id="refresh-stop" type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <i class="fa fa-ban" aria-hidden="true"></i>
                </button>
            </div>
        {% endif %}

        <table class="table">
            <thead class="thead-inverse">
            <tr>
                <th class="col-xs-4">{% trans %}nazwa_paczki_sesji{% endtrans %}</th>
                <th class="col-xs-2">{% trans %}plik_audio{% endtrans %}</th>
                <th class="col-xs-2">{% trans %}transkrypcja{% endtrans %}</th>
                <th class="col-xs-2">{% trans %}segmentacja{% endtrans %}</th>
                <th class="col-xs-1">&nbsp;</th>
            </tr>
            </thead>
            <tbody>
            {% for name,bundle in bundles %}
                <tr>
                    <td>
                        <form action="rename/{{ proj._id }}/{{ name }}" method="post" class="bundle-names">
                            <div class="row">
                                <label class="col-form-label col-2">
                                    <small>SESS</small>
                                </label>
                                <input name="session" value="{{ bundle.session }}" oldvalue="{{ bundle.session }}"
                                       class="form-control col-9">
                            </div>
                            <div class="row">
                                <label class="col-form-label col-2">
                                    <small>NAME</small>
                                </label>
                                <input name="name" value="{{ name }}" oldvalue="{{ name }}" class="form-control col-9">
                            </div>
                        </form>
                    </td>
                    <!--AUDIO-->
                    <td>
                        {% if 'audio' in bundle %}
                            <div class="row">
                                <div class="col-7">
                                    {% if bundle.audio.file %}
                                        <a href="/tools/ui/view/{{ bundle.audio._id }}"
                                           class="btn btn-secondary btn-lg">
                                            <i class="fa fa-file-audio-o fa-2x" aria-hidden="true"></i>
                                        </a>
                                    {% else %}
                                        {% if 'error' in bundle.audio %}
                                            <a class="btn btn-secondary btn-lg"
                                               title="{% trans %}błąd{% endtrans %}">
                                                <i class="fa fa-times-circle fa-2x" style="color: red"></i>
                                            </a>
                                        {% else %}
                                            <a class="btn btn-secondary btn-lg"
                                               title="{% trans %}przetwarzam{% endtrans %}">
                                                <i class="fa fa-refresh fa-spin fa-2x fa-fw"></i>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="col-3">
                                    <a href="remove_bndl/{{ proj._id }}/{{ name|urlencode }}?audio"
                                       class="btn btn-danger btn-sm ask-delete"
                                       title="{% trans %}usuń{% endtrans %}">
                                        <i class="fa fa-trash-o" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </div>
                        {% else %}
                            <div class="row">
                                <div class="col-7">
                                    <a class="btn btn-secondary btn-lg disabled">
                                        <i class="fa fa-file-audio-o fa-2x" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="col-3">
                                    <label for="audio{{ name }}" type="file" class="btn btn-info btn-sm">
                                        <i class="fa fa-upload" aria-hidden="true"></i>
                                    </label>
                                </div>
                            </div>
                            <form action="add_audio/{{ proj._id }}" method="post" enctype="multipart/form-data"
                                  style="display: none">
                                <input type="hidden" name="name" value="{{ name }}">
                                <input id="audio{{ name }}" name="file" type="file" onchange="form.submit()">
                            </form>
                        {% endif %}
                    </td>
                    <!--TRANSCRIPTION-->
                    <td>
                        {% if 'trans' in bundle %}
                            <div class="row">
                                <div class="col-7">
                                    {% if bundle.trans.file %}
                                        {% if 'audio' in bundle and bundle.audio.file %}
                                            <a href="/tools/ui/multiview/{{ bundle.trans._id }}/{{ bundle.audio._id }}"
                                               class="btn btn-secondary btn-lg">
                                                <i class="fa fa-file-text-o fa-2x" aria-hidden="true"></i>
                                            </a>
                                        {% else %}
                                            <a href="/tools/ui/view/{{ bundle.trans._id }}"
                                               class="btn btn-secondary btn-lg">
                                                <i class="fa fa-file-text-o fa-2x" aria-hidden="true"></i>
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        {% if 'error' in bundle.trans %}
                                            <a class="btn btn-secondary btn-lg"
                                               title="{% trans %}błąd{% endtrans %}">
                                                <i class="fa fa-times-circle fa-2x" style="color: red"></i>
                                            </a>
                                        {% else %}
                                            <a class="btn btn-secondary btn-lg"
                                               title="{% trans %}przetwarzam{% endtrans %}">
                                                <i class="fa fa-refresh fa-spin fa-2x fa-fw"></i>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="col-3">
                                    <a href="remove_bndl/{{ proj._id }}/{{ name|urlencode }}?trans"
                                       class="btn btn-danger btn-sm ask-delete"
                                       title="{% trans %}usuń{% endtrans %}">
                                        <i class="fa fa-trash-o" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </div>
                        {% else %}
                            <div class="row">
                                <div class="col-7">
                                    <a class="btn btn-secondary btn-lg disabled">
                                        <i class="fa fa-file-text-o fa-2x" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="col-3">
                                    <div>
                                        <label for="trans{{ name }}" type="file" class="btn btn-info btn-sm">
                                            <i class="fa fa-upload" aria-hidden="true"></i>
                                        </label>
                                    </div>
                                    <div>
                                        {% if 'audio' in bundle and bundle.audio.file %}
                                            <a href="reco/{{ proj._id }}/{{ name|urlencode }}"
                                               class="btn btn-warning btn-sm ask-any"
                                               title="{% trans %}wygeneruj_automatycznie{% endtrans %}">
                                                <i class="fa fa-cogs" aria-hidden="true"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <form action="add_trans/{{ proj._id }}" method="post" enctype="multipart/form-data"
                                  style="display: none">
                                <input type="hidden" name="name" value="{{ name }}">
                                <input id="trans{{ name }}" name="file" type="file" onchange="form.submit()">
                            </form>
                        {% endif %}
                    </td>
                    <!--SEGMENTATION-->
                    <td>
                        {% if 'seg' in bundle %}
                            <div class="row">
                                <div class="col-7">
                                    {% if bundle.seg.file %}
                                        <a href="/tools/ui/view/{{ bundle.seg._id }}" class="btn btn-secondary btn-lg">
                                            <i class="fa fa-file-code-o fa-2x" aria-hidden="true"></i>
                                        </a>
                                    {% else %}
                                        {% if 'error' in bundle.seg %}
                                            <a class="btn btn-secondary btn-lg"
                                               title="{% trans %}błąd{% endtrans %}">
                                                <i class="fa fa-times-circle fa-2x" style="color: red"></i>
                                            </a>
                                        {% else %}
                                            <a class="btn btn-secondary btn-lg"
                                               title="{% trans %}przetwarzam{% endtrans %}">
                                                <i class="fa fa-refresh fa-spin fa-2x fa-fw"></i>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="col-3">
                                    <a href="remove_bndl/{{ proj._id }}/{{ name|urlencode }}?seg"
                                       class="btn btn-danger btn-sm ask-delete"
                                       title="{% trans %}usuń{% endtrans %}">
                                        <i class="fa fa-trash-o" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </div>
                        {% else %}
                            <div class="row">
                                <div class="col-7">
                                    <a class="btn btn-secondary btn-lg disabled">
                                        <i class="fa fa-file-code-o fa-2x" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="col-3">
                                    {% if 'audio' in bundle and bundle.audio.file and 'trans' in bundle and bundle.trans.file %}
                                        <a href="align/{{ proj._id }}/{{ name|urlencode }}"
                                           class="btn btn-warning btn-sm ask-any"
                                           title="{% trans %}wygeneruj_automatycznie{% endtrans %}">
                                            <i class="fa fa-cogs" aria-hidden="true"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </td>
                    <!--TOOLS-->
                    <td>
                        <a href="remove_bndl/{{ proj._id }}/{{ name|urlencode }}"
                           class="btn btn-danger ask-delete"
                           title="{% trans %}usuń_paczkę{% endtrans %}">
                            <i class="fa fa-trash" aria-hidden="true"></i>
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!--TOOLS for whole bundle-->

    <div class="card form-control card-block emu-toolbar">

        <h3>{% trans %}narzędzia_całego_projektu_tytuł{% endtrans %}</h3>

        <p>{% trans %}narzędzia_całego_projektu_opis1{% endtrans %}</p>

        <p>{% trans %}narzędzia_całego_projektu_opis2{% endtrans %}</p>

        <div class="row">
            <div class="col-lg-3">
                {% if disable.asr %}
                    <a class="btn btn-warning btn-lg disabled" style="height: 8em">
                {% else %}
                    <a href="reco/{{ proj._id }}" class="btn btn-warning btn-lg ask-any" style="height: 8em"
                       title="{% trans %}wykonaj_asr{% endtrans %}">
                {% endif %}
                <i class="fa fa-file-audio-o fa-2x"></i>
                <i class="fa fa-arrow-right fa-2x"></i>
                <i class="fa fa-file-text-o fa-2x"></i>
                </a>
            </div>
            <div class="col-lg-3">
                {% if disable.align %}
                    <a class="btn btn-warning btn-lg disabled" style="height: 8em">
                {% else %}
                    <a href="align/{{ proj._id }}" class="btn btn-warning btn-lg ask-any" style="height: 8em"
                       title="{% trans %}wykonaj_align{% endtrans %}">
                {% endif %}
                <i class="fa fa-file-text-o fa-2x"></i>
                <i class="fa fa-arrow-right fa-2x"></i>
                <i class="fa fa-file-code-o fa-2x"></i>
                </a>
            </div>
            <div class="col-lg-3">
                {% if disable.emu %}
                    <a class="btn btn-info btn-lg disabled" style="height: 8em">
                {% else %}
                    <a href="webapp/{{ proj._id }}" class="btn btn-info btn-lg" target="_blank" style="height: 8em"
                       title="{% trans %}otwórz_webapp{% endtrans %}">
                {% endif %}
                <img src={{ url_for('static', filename='img/emuIcon.png') }}>
                </a>
            </div>
            <div class="col-lg-3">
                {% if disable.emu %}
                    <a class="btn btn-info btn-lg disabled" style="height: 8em">
                {% else %}
                    <a href="download/{{ proj._id }}" class="btn btn-info btn-lg" style="height: 8em"
                       title="{% trans %}ściągnij_projekt{% endtrans %}">
                {% endif %}
                <i class="fa fa-download fa-2x"></i>
                </a>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        Dropzone.options.addAudio = {
            maxFilesize: 100,
            init: function () {
                this.on('queuecomplete', function () {
                    location.reload(true);
                });
                this.on('totaluploadprogress', function (uploadProgress, totalBytes, totalBytesSent) {
                    bar = $('#uploadProgress');
                    bar.html(uploadProgress + '%');
                    bar.css('width', uploadProgress + '%');
                    bar.attr('aria-valuenow', uploadProgress);
                });
            }
        };

        $(".ask-delete").each(function () {
            $(this).click(function () {
                if (!confirm('{% trans %}czy_usunąć_zasób{% endtrans %}'))
                    return false;
            });
        });

        $(".ask-any").each(function () {
            $(this).click(function () {
                if (!confirm('{% trans %}czy_wykonać_akcję{% endtrans %}'))
                    return false;
            });
        });

        var bundle_names = {{ bundle_names|tojson }};

        $(".bundle-names").each(function () {
            $(this).keypress(function (e) {
                if (e.which == 13) {

                    new_value = e.target.value;
                    old_value = e.target.attributes['oldvalue'].value;

                    if (old_value != new_value) {

                        if (e.target.name == 'name') {
                            if ($.inArray(new_value, bundle_names) >= 0) {
                                alert('{% trans %}nazwa_już_istnieje{% endtrans %}');
                                return false;
                            }
                        }

                        $(this).closest('form').submit();
                    }
                }
            });
        });

        {% if refresh_req %}
            function refresh_page() {
                location.reload();
            }
            $('#refresh-link').click(refresh_page);
            var sec_remaining = 5;
            function refresh_tick() {
                if (sec_remaining > 1) {
                    sec_remaining--;
                    $('#refresh-sec').html(sec_remaining);
                    setTimeout(refresh_tick, 1000);
                } else if (sec_remaining >= 0) {
                    refresh_page();
                }
            }
            setTimeout(refresh_tick, 1000);
            $('#refresh-stop').click(function () {
                sec_remaining = -1;
            });
        {% endif %}
    </script>

{% endblock %}